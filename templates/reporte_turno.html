{% extends "base.html" %}

{% block title %}Reporte de Turno{% endblock %}

{% block body_class %}dashboard-body{% endblock %}

{% block header %}
{% if nombre and es_admin is not none %}
{% include "partials/_header.html" %}
{% endif %}
{% endblock %}

{% block content %}
<div class="reporte-container">
    <!-- Header del reporte -->
    <div class="reporte-header">
        <h2>Reporte de Turno</h2>
        <div class="reporte-actions no-print">
            <button class="btn btn-primario" onclick="window.print()">üñ®Ô∏è Imprimir</button>
            {% if es_admin %}
            <a href="/admin" class="btn btn-secundario">Volver al Admin</a>
            {% else %}
            <a href="/dashboard" class="btn btn-secundario">Volver</a>
            {% endif %}
        </div>
    </div>

    <!-- Metadata del turno -->
    <div class="reporte-meta">
        <div class="reporte-meta-item">
            <span class="reporte-meta-label">Trabajador</span>
            <span class="reporte-meta-value">{{ trabajador }}</span>
        </div>
        <div class="reporte-meta-item">
            <span class="reporte-meta-label">Inicio de turno</span>
            <span class="reporte-meta-value">{{ inicio_turno }}</span>
        </div>
        <div class="reporte-meta-item">
            <span class="reporte-meta-label">Fin de turno</span>
            <span class="reporte-meta-value">{{ fin_turno }}</span>
        </div>
        <div class="reporte-meta-item">
            <span class="reporte-meta-label">Estado</span>
            <span class="reporte-meta-value">
                {% if estado_turno == 'cerrado' %}
                <span class="badge badge-inactive">Cerrado</span>
                {% else %}
                <span class="badge badge-active">Abierto</span>
                {% endif %}
            </span>
        </div>
    </div>

    <!-- KPIs del turno -->
    <div class="admin-kpis">
        <div class="kpi-card">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-info">
                <span class="kpi-label">Total Cobrado</span>
                <span class="kpi-value" style="color: var(--success);">S/ {{ "%.2f"|format(stats.total_cobrado) }}</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üíµ</div>
            <div class="kpi-info">
                <span class="kpi-label">Efectivo</span>
                <span class="kpi-value">S/ {{ "%.2f"|format(stats.total_efectivo) }}</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><img src="/static/img/yape.png" alt="Yape" class="yape-icon-lg"></div>
            <div class="kpi-info">
                <span class="kpi-label">Yape</span>
                <span class="kpi-value" style="color: var(--primary);">S/ {{ "%.2f"|format(stats.total_yape) }}</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üì•</div>
            <div class="kpi-info">
                <span class="kpi-label">Ingresaron</span>
                <span class="kpi-value">{{ stats.autos_ingresados }}</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üì§</div>
            <div class="kpi-info">
                <span class="kpi-label">Salieron</span>
                <span class="kpi-value">{{ stats.autos_salieron }}</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üöó</div>
            <div class="kpi-info">
                <span class="kpi-label">En Cochera</span>
                <span class="kpi-value">{{ stats.autos_en_cochera }}</span>
            </div>
        </div>
    </div>

    <!-- Desglose -->
    <div class="reporte-breakdown">
        <div class="reporte-breakdown-item">
            Adelantos: <strong>S/ {{ "%.2f"|format(stats.total_adelantos) }}</strong>
        </div>
        <div class="reporte-breakdown-item">
            Cobros salida: <strong>S/ {{ "%.2f"|format(stats.total_cobros) }}</strong>
        </div>
        <div class="reporte-breakdown-item">
            Penalidades: <strong>S/ {{ "%.2f"|format(stats.total_penalidades) }}</strong>
        </div>
    </div>

    <!-- Cuadre de caja (solo si turno cerrado) -->
    {% if stats.efectivo_declarado is not none %}
    <h3 class="reporte-section-title">Cuadre de Caja</h3>
    <div class="reporte-cuadre">
        <div class="cuadre-row">
            <div class="cuadre-item">
                <span class="cuadre-label">üíµ Efectivo sistema</span>
                <span class="cuadre-value">S/ {{ "%.2f"|format(stats.total_efectivo) }}</span>
            </div>
            <div class="cuadre-item">
                <span class="cuadre-label">üíµ Efectivo declarado</span>
                <span class="cuadre-value">S/ {{ "%.2f"|format(stats.efectivo_declarado or 0) }}</span>
            </div>
            <div class="cuadre-item">
                <span class="cuadre-label">üìä Diferencia</span>
                {% set dif_ef = stats.dif_efectivo or 0 %}
                <span class="cuadre-value {% if dif_ef < 0 %}texto-danger{% elif dif_ef > 0 %}texto-warning{% else %}texto-exito{% endif %}">
                    S/ {{ "%.2f"|format(dif_ef) }}
                </span>
            </div>
        </div>
        <div class="cuadre-row">
            <div class="cuadre-item">
                <span class="cuadre-label"><img src="/static/img/yape.png" alt="Yape" class="yape-icon"> Yape sistema</span>
                <span class="cuadre-value">S/ {{ "%.2f"|format(stats.total_yape) }}</span>
            </div>
            <div class="cuadre-item">
                <span class="cuadre-label"><img src="/static/img/yape.png" alt="Yape" class="yape-icon"> Yape declarado</span>
                <span class="cuadre-value">S/ {{ "%.2f"|format(stats.yape_declarado or 0) }}</span>
            </div>
            <div class="cuadre-item">
                <span class="cuadre-label">üìä Diferencia</span>
                {% set dif_ya = stats.dif_yape or 0 %}
                <span class="cuadre-value {% if dif_ya < 0 %}texto-danger{% elif dif_ya > 0 %}texto-warning{% else %}texto-exito{% endif %}">
                    S/ {{ "%.2f"|format(dif_ya) }}
                </span>
            </div>
        </div>
        <div class="cuadre-total">
            {% set dif_total = (stats.dif_efectivo or 0) + (stats.dif_yape or 0) %}
            <span>Diferencia Total:</span>
            <strong class="{% if dif_total < 0 %}texto-danger{% elif dif_total > 0 %}texto-warning{% else %}texto-exito{% endif %}">
                S/ {{ "%.2f"|format(dif_total) }}
                {% if dif_total == 0 %}(Cuadrado){% elif dif_total > 0 %}(Sobrante){% else %}(Faltante){% endif %}
            </strong>
        </div>
    </div>
    {% endif %}

    {% if observaciones %}
    <div class="reporte-observaciones">
        <strong>Observaciones:</strong> {{ observaciones }}
    </div>
    {% endif %}

    <!-- Detalle de movimientos -->
    <h3 class="reporte-section-title">Detalle de Movimientos</h3>
    <div class="table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Tipo</th>
                    <th>Placa</th>
                    <th>Cliente</th>
                    <th>Monto</th>
                    <th>Metodo</th>
                    <th>Descripcion</th>
                </tr>
            </thead>
            <tbody>
                {% for d in detalles %}
                <tr>
                    <td class="fecha-col">{{ d.fecha_movimiento }}</td>
                    <td><span class="badge badge-info">{{ d.tipo }}</span></td>
                    <td><strong>{{ d.placa or '-' }}</strong></td>
                    <td>{{ d.cliente or '-' }}</td>
                    <td class="monto-col">S/ {{ "%.2f"|format(d.monto) }}</td>
                    <td>
                        {% if d.metodo_pago == 'yape' %}
                        <span class="badge badge-yape">Yape</span>
                        {% else %}
                        <span class="badge badge-efectivo">Efectivo</span>
                        {% endif %}
                    </td>
                    <td style="max-width:200px;" class="truncate">{{ d.descripcion or '' }}</td>
                </tr>
                {% endfor %}
                {% if not detalles %}
                <tr>
                    <td colspan="7" class="tabla-vacia">
                        <div class="empty-state">
                            <span class="empty-icon">üìã</span>
                            <p>Sin movimientos en este turno</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
